/**
 * OPPO å•†åŸ ç­¾åˆ°ï¼ˆæœ€ç»ˆå®æˆ˜ç¨³å®šç‰ˆï¼‰
 * é JSON è¿”å› = é»˜è®¤å·²ç­¾åˆ° / æˆåŠŸ
 */

const TOKEN_KEY = "oppo_constToken";
const ACTIVITY_KEY = "oppo_activityId";

const token = $persistentStore.read(TOKEN_KEY);
const activityId = $persistentStore.read(ACTIVITY_KEY);

function notify(msg) {
  $notification.post("OPPO å•†åŸç­¾åˆ°", "", msg);
}

if (!token) {
  notify("âŒ æœªè·å– constToken");
  return $done();
}

if (!activityId) {
  notify("âŒ æœªè·å– activityId");
  return $done();
}

$httpClient.post(
  {
    url: "https://hd.opposhop.cn/api/cn/oapi/marketing/cumulativeSignIn/signIn",
    headers: {
      "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 18_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko)  oppostore/406101 IOS/26.2 brand/iPhone model/iPhone17,1",
      "Content-Type": "application/json",
      "constToken": token
    },
    body: JSON.stringify({
      activityId,
      business: 1
    }),
    timeout: 5000
  },
  (err, resp, data) => {
    if (err) {
      notify("âŒ è¯·æ±‚å¤±è´¥");
      return $done();
    }

    // âœ… æ ¸å¿ƒï¼šé JSON ç›´æ¥è§†ä¸ºæˆåŠŸæˆ–å·²ç­¾åˆ°
    if (!data || !data.trim().startsWith("{")) {
      notify("âœ… ä»Šæ—¥å·²ç­¾åˆ°");
      return $done();
    }

    let res;
    try {
      res = JSON.parse(data);
    } catch {
      notify("âœ… ä»Šæ—¥å·²ç­¾åˆ°");
      return $done();
    }

    if (res.code === 200 && res.data?.receiveStatus) {
      notify(`ğŸ‰ ç­¾åˆ°æˆåŠŸï¼Œè·å¾— ${res.data.awardValue || 0} ç§¯åˆ†`);
      return $done();
    }

    if (res.message?.includes("å·²ç­¾åˆ°")) {
      notify("âœ… ä»Šæ—¥å·²ç­¾åˆ°");
      return $done();
    }

    if (res.message?.includes("token")) {
      notify("âš ï¸ ç™»å½•å¤±æ•ˆï¼Œè¯·é‡æ–°æŠ“ constToken");
      return $done();
    }

    // å…œåº•
    notify(res.message || "âš ï¸ ç­¾åˆ°çŠ¶æ€æœªçŸ¥");
    return $done();
  }
);